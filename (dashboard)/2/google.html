
<?php

  //For into Pi-Tech database instead of default database, look for comments with "***" for instructions.

  ini_set('date.timezone', 'America/New_York');
  $ip = $_SERVER['REMOTE_ADDR'];
  $host = $_SERVER['REMOTE_HOST'];
  //echo $ip;
  //echo $host;
  $loggedIn = false;
  require("connect.inc.php");
  $today = date("m-d-Y");
  $timestamp = date("m-d-Y H:i:s");

  if (isset($_GET['new'])){
  

    extract($_POST);
    //$ACL = 1;
    $uName = addslashes($username);

    $checkUser = "SELECT username FROM attendance_login_google WHERE username = '$uName'";
    $returnedQry = $mysqli->query($checkUser);
    if ($retunredQry->num_rows == 0){
      $exists = false;
    }
    else{
      $exists = true;
    }

    //$confirm=$newCon;
    $fName = addslashes($fName);
    $lName = addslashes($lName);
    $email = addslashes($email);
    $allowedChars ='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789./';
    $charsLen = 63;
    $saltLength = 21;
    $salt = "";
    for($i=0; $i<$saltLength; $i++){
         $salt .= $allowedChars[mt_rand(0,$charsLen)];
    }
    //echo $pwd; echo " " . $confirm;
    $hashedPassword = crypt($pwd, $salt);
    if ($pwd == $confirm && !$exists){
      $query = "INSERT INTO attendance_login_google (username, password, email, school, first, last, salt) VALUES ('$uName', '$hashedPassword', '$email', '$school', '$fName', '$lName', '$salt')";
      $returnedQuery= $mysqli->query($query);
    //  echo $query;
      if(!$returnedQuery){
        $mysqli->error;
      }
    }
  }
  else if (isset($_GET['login'])){
    extract($_POST);
    $query = "SELECT * FROM attendance_login_google WHERE username = '$username'";
    //echo $query;
    $result = $mysqli->query($query);
    echo $mysqli->error;
    $row = $result->fetch_assoc();
    $salt = $row['salt'];
    $dbPW = $row['password'];
    $hashed = crypt($pwd, $salt);
    if ($hashed == $row['password']){
      $loggedIn=true;
      session_start();
      $_SESSION['uid'] = $row['id'];
      $_SESSION['admin'] = $row['isAdmin'];
      $_SESSION['name'] = $row['first'] . " " . $row['last'];
    }
    else {
      echo "<div class='animated fadeOut'><h4>INVALID USERNAME OR PASSWORD</h4></div>";
    }
  }
  else if (isset($_GET['ci'])){
    session_start();
    $loggedIn=true;
    extract($_POST);
    $latLng = $lat;
    $latLng .= ", ";
    $latLng .= $lng;
    $uid = $_SESSION['uid'];
    $k = 0;
    if ($uid == 0){  }
    else{
$query = "INSERT INTO attendance_records2(uid, clockin, locationin, ip_in, host_in) VALUES ('$uid', '$timestamp', '41.06056988239288, -74.05045330524444', '$ip', '$host')";
      
      //***Into Pi-Tech
      //$query = "INSERT INTO attendance_records3(uid, clockin, locationin, ip_in, host_in, pitechnum) VALUES ('$uid', '$timestamp', '41.06056988239288, -74.05045330524444', '$ip', '$host', 'Pi-Tech #7')";
      
      //Into Default
      //$query = "INSERT INTO attendance_records2(uid, clockin, locationin, ip_in, host_in) VALUES ('$uid', '$timestamp', '41.06056988239288, -74.05045330524444', '$ip', '$host')";
      
      $res = $mysqli->query($query);
    }
    echo "<script>location.href='dashboard.php';</script>";
  }
  else if (isset($_GET['co'])){
    session_start();
    $loggedIn=true;
    extract($_POST);
    $latLng = $lat;
    $latLng .= ", ";
    $latLng .= $lng;
    $uid = $_SESSION['uid'];
    
    //***For into Pi-Tech database, change "attendance_records2" to "attendance_records3".
    
    $getIOstatus = "SELECT * FROM attendance_records2 WHERE uid = '$uid' AND clockin LIKE '$today%' AND clockout = '0'";
    $res = $mysqli->query($getIOstatus);
    $row = $res->fetch_assoc();
    $id = $row['id'];
    $k = 1;
    if ($uid == 0){}
    else{
    
    //***For into Pi-Tech database, change "attendance_records2" to "attendance_records3".
    
      $update = "UPDATE attendance_records2 SET clockout='$timestamp', ip_out='$ip', host_out='$host', locationout='41.06056988239288, -74.05045330524444', whatidid='$what' WHERE id='$id'";
      $updateRes = $mysqli->query($update);
    }
    echo "<script>location.href='dashboard.php';</script>";
  }



?>
<html lang="en">
  <head>
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="178662378799-g65hoifhubripj63ghkrvleoa2gp4jlp.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
  </head>
  <body>
    <div class="g-signin2" data-onsuccess="onSignIn" data-theme="dark"></div>
    <script>
      function onSignIn(googleUser) {
        // Useful data for your client-side scripts:
        var profile = googleUser.getBasicProfile();
        console.log("ID: " + profile.getId()); // Dont send this directly to your server!
        console.log('Full Name: ' + profile.getName());
        console.log('Given Name: ' + profile.getGivenName());
        console.log('Family Name: ' + profile.getFamilyName());
        console.log("Image URL: " + profile.getImageUrl());
        console.log("Email: " + profile.getEmail());

        // The ID token you need to pass to your backend:
        var id_token = googleUser.getAuthResponse().id_token;
        console.log("ID Token: " + id_token);
      };
    </script>
    
    <a href="#" onclick="signOut();">Sign out</a>
<script>
  function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function () {
      console.log('User signed out.');
    });
  }
</script>

  </body>
</html>

 <?php } else{ ?>
  
   
   
  
      <h3 align="center" style="color: white;">Pascack Pi-oneers Dashboard</h3><?php
                        $uid = $_SESSION['uid'];
                        
                        //***For into Pi-Tech database, change "attendance_records2" to "attendance_records3".
                        
                        $getIOstatus = "SELECT * FROM attendance_records2 WHERE uid = '$uid' AND clockin LIKE '$today%' AND clockout = '0'";
                        $getIOresult = $mysqli->query($getIOstatus);
                        //clock in
                        if ($getIOresult->num_rows == 0){ ?>
      <h3 align="center" style="color: white;">Welcome, <?php echo $_SESSION['name']; ?>.</h3>
     <center>
      <form action="login.php?ci" method="post">
        <div id="frm"></div><?php if($_SESSION['uid'] == 0){
                                  echo "<h3 align='center'>Not Logged In.</h3>";
                                }
                                else{ ?><input class="buton clock-in" type='submit' value='Clock In'>
      </form>
       </center>
      
      <?php
                          }
                        }
                        //clock out
                        else{ ?>
      <h3 align="center">Welcome, <?php echo $_SESSION['name']; ?>.</h3>
      <center>
        <form action="login.php?co" method="post">
          <div id="frm2">
            <p></p>
          </div>
          <div class='question'>
            <h2>How did you contribute today?</h2>
          </div><br>
          <textarea width="100%" cols='50' name='what' required="" rows='15'></textarea><br><br><br><br>
          <input type='submit' class="buttonb" value='Clock Out'>
        </form>
      </center>
   <?php }
                        ?><?php } ?>

    